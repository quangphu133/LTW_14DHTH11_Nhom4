@model IEnumerable<WebApplication1.Models.sp_DoanhThuTheoNgay_Result>

@{
    ViewBag.Title = "Báo cáo Doanh Thu Theo Ngày";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="well" style="margin-bottom: 20px;">
    @using (Html.BeginForm("DoanhThuTheoNgay", "BaoCao", FormMethod.Post, new { @class = "form-inline text-center" }))
    {
        <div class="form-group" style="margin-right: 15px;">
            <label style="margin-right: 5px;">Từ ngày:</label>
            <input type="date" name="tuNgay" value="@ViewBag.TuNgay" class="form-control" required />
        </div>

        <div class="form-group" style="margin-right: 15px;">
            <label style="margin-right: 5px;">Đến ngày:</label>
            <input type="date" name="denNgay" value="@ViewBag.DenNgay" class="form-control" required />
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="glyphicon glyphicon-search"></i> Xem báo cáo
        </button>
    }
</div>

@if (Model != null && Model.Any())
{
    <div class="alert alert-success text-center" style="font-size: 16px;">
        <strong>Tổng doanh thu trong giai đoạn này: </strong>
        <span style="color: red; font-weight: bold; font-size: 20px;">
            @string.Format("{0:N0} VNĐ", ViewBag.TongDoanhThu ?? 0)
        </span>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="panel panel-default">
                <div class="panel-heading">Biểu đồ xu hướng</div>
                <div class="panel-body">
                    <canvas id="chartDoanhThu" style="width:100%; height:400px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="panel panel-info">
                <div class="panel-heading">Chi tiết từng ngày</div>
                <div class="panel-body" style="max-height: 430px; overflow-y: auto;">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr class="info">
                                <th>Ngày</th>
                                <th class="text-right">Doanh Thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        @if (item.Ngay.HasValue)
                                        {
                                            @item.Ngay.Value.ToString("dd/MM/yyyy")
                                        }
                                    </td>
                                    <td class="text-right">
                                        @item.DoanhThu.GetValueOrDefault(0).ToString("N0")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            // 1. Chuẩn bị dữ liệu từ Model sang JS an toàn bằng Json
            // Select Ngay và format thành chuỗi dd/MM
            var labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => x.Ngay.HasValue ? x.Ngay.Value.ToString("dd/MM") : "")));

            // Select DoanhThu, xử lý null thành 0
            var dataValues = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => x.DoanhThu.GetValueOrDefault(0))));

            // 2. Vẽ biểu đồ
            const ctx = document.getElementById('chartDoanhThu').getContext('2d');

            new Chart(ctx, {
                type: 'bar', // Có thể đổi thành 'line' nếu muốn xem dạng đường
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: dataValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        tension: 0.1 // Làm mềm đường cong nếu dùng biểu đồ line
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString("vi-VN") + " đ";
                                }
                            }
                        }
                    }
                }
            });
        </script>
    }
}
else
{
    if (Request.HttpMethod == "POST")
    {
        <div class="alert alert-warning text-center">
            <h4>Không có dữ liệu doanh thu nào trong khoảng thời gian này.</h4>
        </div>
    }
    else
    {
        <div class="text-center text-muted">
            <p>Vui lòng chọn khoảng thời gian và bấm "Xem báo cáo"</p>
        </div>
    }
}